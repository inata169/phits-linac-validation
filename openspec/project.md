# プロジェクト仕様（draft v0.3）

本ドキュメントは「OCR比較時に、絶対線量をPDDから取得し、物理的に正しく評価したい」を達成するための実装方針・要件・評価基準を定義します。

## 目的
- PDD（Percent Depth Dose）から各深さのスケール因子を導出し、同深のOCRへ適用して、PHITS計算値と実測の“物理的に妥当な”比較（γ/RMSE）を可能にする。
- 相対比較（正規化プロファイル同士）に加え、深さ依存の重み付け（PDD）を掛けた真値スケールで評価する。

## スコープ
- 対象: 水等価環境における基本場（例: 10×10 cm²）でのPDDとOCR。
- 入力: reference/eval ともに CSV または PHITS `.out`（混在可）。
- 出力: 真値スケール適用後の比較グラフ、レポート（RMSE/γパス率、用いたスケーリング根拠を記録）。
- 非対象: 個別患者プラン、組織非等質の詳細モデル化、MU校正の院内基準策定。

## データ仕様（入力/正規化）
- 共通単位
  - 位置: cm（内部処理は mm に変換可、I/O は cm 基本）
  - 線量: 正規化量 0.00–1.00（範囲外はローダ側で最大値基準の正規化とクランプ）
- 入力ソースの対称性
  - reference, eval ともに CSV または PHITS `.out` を受理（混在も可）。
- CSV 仕様（reference/eval 共通）
  - 列: `pos_cm`, `dose_norm` 相当（ヘッダは `X (cm)`/`Y (cm)`/`Z (cm)` と数値2列を許容、UTF-8 SIG 可）。
  - 値域: `dose_norm ∈ [0,1]` を推奨。範囲外は最大値で正規化の上、[0,1] にクランプ。
- PHITS `.out`（reference/eval 共通）
  - `[ T-Deposit ]`（表記揺れ含む）の最終ブロックから `nx/ny/nz` を取得し軸を同定。
  - 座標は cm に換算して出力インターフェースを統一。
  - 線量は系列の最大値 or 中心値で 0–1 に正規化（モード切替は将来拡張）。

### データ種別
- PDD（深さ方向プロファイル）
  - 軸: `Z (cm)`、系列: `dose_norm(z)`（0–1）。
  - 既定の基準: `dmax` 正規化（最大=1.00）。`z_ref` 正規化にも対応（後述）。
- OCR（横方向プロファイル）
  - 軸: `X (cm)`（または `Y (cm)`）、深さ `z` 固定の系列: `dose_norm(x; z)`（0–1）。
  - 既定の正規化: 中心 `x=0` を 1.00 に正規化。`x=0` が無い場合は ±0.05 cm の最近傍サンプル、無ければ最大値を中心代理とする。

## 真値スケーリング（PDD→OCRへの適用）
目的は「OCRの振幅を、その深さのPDDで物理的に重み付けした“真値”スケールへ変換し、reference/eval 同条件で比較」すること。

1) 参照条件の定義（確定）
   - PDD正規化基準: 既定を `dmax`、選択肢として `z_ref=10 cm` を許容。
2) 深さごとのスケール因子（中央軸“真値”）
   - `S_axis(z) = PDD_norm(z)`
3) OCRの“真値”化
   - OCR 中心を 1.00 に正規化した `OCR_rel(x,z)` に対し、`True(x,z) = S_axis(z) * OCR_rel(x,z)` を構成。
4) reference/eval の双方に同一手順を適用し、比較の基盤を揃える。

備考:
- 本手順は cGy 等の絶対単位を必須としない。両系列を“同一PDD重み”に乗せるため、物理的整合性が向上する。
- 院内校正に基づく cGy アンカーが必要な場合は、`D_ref_abs` を追加し `True_abs(x,z) = D_ref_abs * True(x,z)` に拡張可能（将来オプション）。
- 深さの補間: OCR深がPDDの離散点に無い場合、PDDを深さ方向に線形補間。

## 評価指標と比較手順
- 入力系列の整列
  - 軸は `cm` で受理（γ計算内部で `mm` に換算）。
  - PDD は線形補間で `z` を揃える（OCR の深さに合わせる）。
  - OCR の横軸は γ 実装が内挿対応のため原則そのまま使用。ただし RMSE/可視化で比較が不安定なときは共通グリッドへ再サンプル（既定 0.1 cm）。
- 真値系列の構築
  - reference/eval それぞれで `True(x,z) = PDD_norm(z) * OCR_rel(x,z)` を構成。
- RMSE（真値スケール）
  - `RMSE = sqrt(mean((True_ref - True_eval)^2))`（系列共通点にて）。
- γ評価
  - 基準: reference True を基準系列、eval True を評価系列とする。
  - 第一優先: DD=2%, DTA=2 mm, Cutoff=10%
  - 第二優先: DD=3%, DTA=3 mm, Cutoff=10%
  - DD(%) は reference True の最大値に対するグローバル％（local も選択可）。

## 「共通サンプル間隔（再サンプル既定 0.1 cm）」とは
- 背景: reference と eval の `x` 座標が異なる間隔・位置で測定/計算されることがある。
- 目的: RMSE を点ごとに比較したい、あるいは同じグリッドで重ね描きしたい場合に、両系列を同じ `x` 刻みへ補間して揃える操作。
- 既定値: 0.1 cm（必要な場合のみ適用）。十分に密で同等の配置なら再サンプルは行わない。
- 設定: `config.ini` の `[Processing] resample_grid_cm` で既定値を変更可（将来、CLI で一時的に上書き可能に拡張予定）。
- 影響: 物理量を変更するのではなく、数値比較と可視化の安定性を高めるための内挿処理。γ計算は内挿を持つため原則不要だが、RMSE/可視化では有益。

## 測定条件の前提とメタデータ
- 既定の測定条件（メタの標準値）
  - 媒質: 水等価（Water）
  - 幾何: SSD=100 cm（SAD 運用の場合は注記）
  - 照射野: 10×10 cm²（その他条件はメタで保持）
  - 深さ: OCR は 0.5, 10, 20 cm（PDD は表面〜30 cm）
- 代表例（要件サンプル）
  - 線質: 光子線（電子線も可）
  - エネルギー例: 6 MV（4/6/10 MV、6/10 MV FFF、電子 4/6/9/12/15 MeV）
  - 媒質: 水
  - 幾何: SSD=90 cm（SADなら注記）
  - 照射野: 10×10 cm²
  - 深さ: OCR は 5/10/20 cm
- メタデータ（将来拡張）
  - 各 CSV/PHITS について、`energy`, `SSD/SAD`, `field_size`, `depth` をヘッダやサイドカーJSONで保持可能にする。

## CLI 仕様（拡張案）
- 既存引数に加え、以下を追加（後方互換の既定値）
  - `--from-pdd`（bool）: PDD重みで“真値”を構成して比較（既定: true 推奨）
  - `--pdd-ref-type <csv|phits>`: reference 用PDDソース種別
  - `--pdd-ref-file <path>`: reference 用PDDファイル
  - `--pdd-eval-type <csv|phits>`: eval 用PDDソース種別
  - `--pdd-eval-file <path>`: eval 用PDDファイル
  - `--norm-mode <dmax|z_ref>`: PDD 正規化方式（既定: `dmax`）
  - `--z-ref <cm>`: `norm-mode=z_ref` の参照深（既定: 10）
  - `--gamma-mode <absolute|local>`: γの基準方式（既定: `absolute`）
  - `--grid <cm>`: 共通サンプル間隔（再サンプルが必要な場合の刻み、既定: 0.1）

注: 本ドラフト時点では実装前提の仕様。実装後、README と AGENTS.md にも反映する。

## 出力仕様の拡張
- グラフ: 凡例に「真値方式（PDD重み）」と参照条件（`norm-mode`, `z_ref`）を明記。
- レポート: 用いたPDDファイル名/ソース、補間方法、`norm-mode`, `z_ref` を明記。

## 受け入れ基準（例）
- 単体（演算検証）
  - 与えたPDD曲線と `norm-mode`, `z_ref` から、`S_axis(z)` が式通りに再現される。
  - OCR中心で `True(x=0,z) = S_axis(z)` を満たす。
- 結合（比較検証）
  - サンプルデータ（10×10 cm², 0.5/10/20 cm）で γ(2%/2mm, 10%Cutoff) のパス率がレポートに出力される（True スケール基準）。
  - 参考として γ(3%/3mm, 10%Cutoff) も出力可能。
  - グラフ/レポートに参照条件とPDDソースが記載される。

## リスク/注意
- PDDの測定条件（SSD, フィールドサイズ）不一致: 参照条件に合わせて補正/注記すること。
- 深さ座標の整合（水表面基準 vs 幾何中心）: CSV/PHITS の軸定義を統一。
- 低線量領域（< 10%）のγはノイズ影響が大きいため、カットオフを厳守。

## 実装計画（短期）
1) CSVローダにPDDモード追加（深さ-線量系列の抽出と補間）
2) 真値スケーリング計算のユーティリティを追加（参照条件・PDD入力）
3) OCR読み込みパスにスケール適用（実測/PHITSの双方）
4) γ評価のモード切替（absolute/local）とレポート出力拡張
5) README / AGENTS.md / 本書の更新

## 将来拡張（3D DICOM-RT）
- 入力: RTDOSE（3D dose grid）, RTPLAN/RTSTRUCT による座標整合
- 抽出: 任意深さ/ビーム軸に沿った PDD/OCR をサンプリング（補間: 線形/三次）
- 比較: 3D γ、または 1D/2D へ射影して本仕様と同等の真値スケーリングで比較

## 参照
- リポジトリ: `src/Comp_measured_phits_v9.1.py`, `config.ini`, `data/`
- 方針連携: `AGENTS.md`（開発規約・I/O仕様）
