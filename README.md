
-----

# PHITS医療用リニアック線量分布評価ツール

[](https://www.python.org/downloads/)

このプロジェクトは、モンテカルロ計算コード **PHITS** を用いてシミュレーションした医療用リニアックの線量分布と、実際に測定した線量分布データを比較・評価するためのPythonスクリプトを提供します。

医学物理の現場、特に放射線治療における品質保証(QA)で日常的に行われる「計算値と実測値の比較」を、研究レベルで実践するためのツールです。

-----

## 🔬 このツールで出来ること

  * **線量分布の比較:** PHITSの出力ファイル(`.out`)と実測のCSVファイルを読み込み、線量プロファイルを比較します。
  * **データ補正機能:**
      * **スケーリング:** シミュレーション結果全体に係数を掛けて、実測値との絶対的な線量差を補正できます。
      * **平滑化 (スムージング):** [Savitzky-Golayフィルター](https://en.wikipedia.org/wiki/Savitzky%E2%80%93Golay_filter)を用いて、モンテカルロ計算特有の統計ノイズを低減します。
  * **評価指標の計算:**
      * **ガンマインデックス (γ-Index)評価:** 放射線治療分野で標準的に用いられる評価指標です。「線量差(DD)」と「位置ずれ(DTA)」を同時に評価し、2つの線量分布がどの程度一致しているかをパーセンテージ（パス率）で示します。
      * **RMSE (Root Mean Square Error):** 平均二乗平方根誤差を計算し、全体的な誤差の大きさを定量的に評価します。
  * **結果の自動出力:**
      * 比較結果を視覚的に確認できるグラフ画像 (`.png`)
      * 使用したパラメータや評価結果をまとめたレポート (`.txt`)

-----

## 🔰 医学物理ビギナー向け解説

### なぜシミュレーションと実測を比べるの？

放射線治療では、コンピュータ（治療計画装置, TPS）上で計算された線量分布が、実際に患者さんの体内で実現される必要があります。この「計算が正しいか」を確認する作業を**コミッショニング**や\*\*品質保証(QA)\*\*と呼び、非常に重要です。

このプロジェクトでは、TPSの代わりにPHITSを使い、「PHITSで構築したリニアックのモデルが、本物のリニアックの特性をどれだけ正確に再現できているか」を検証しています。これが上手くいけば、物理的な実験が難しい様々な条件下での線量の振る舞いを、コンピュータ上で正確に予測できるようになります。

### ガンマインデックスとは？

ガンマインデックスは、線量分布を比較するための「ものさし」のようなものです。

例えば、実測値で「位置10mmの線量が100%」だったとします。計算値が「位置10mmで98%」だった場合、線量差は2%です。もし計算値が「位置10.5mmで100%」だった場合、位置ずれは0.5mmです。

ガンマ評価では、「**線量差3%以内**」かつ「**位置ずれ3mm以内**」のように、2つの許容基準（クライテリア）を設定します。評価したい計算値の各点が、その周辺にある実測値のいずれかと**両方の基準を満たせば「合格(γ ≤ 1)」**、満たさなければ「不合格(γ \> 1)」となります。全評価点のうち、何%が合格したかを示したのが**ガンマパス率**です。一般的に、95%以上であれば非常に良い一致とされます。

### スクリプトにおけるガンマ計算 (`pymedphys.gamma`)

このスクリプトでは、ガンマ計算に`pymedphys`という専門ライブラリを使用しています。具体的には`pymedphys.gamma`関数を呼び出しており、その主要な引数（入力データ）は以下の通りです。

  * `axes_ref`, `dose_ref`

      * **内容:** **実測データ**の座標軸（`axes_ref`）と線量値（`dose_ref`）です。
      * **単位:** 座標軸は\*\*ミリメートル (mm)\*\*で渡す必要があります。

  * `axes_eval`, `dose_eval`

      * **内容:** **PHITSデータ**の座標軸（`axes_eval`）と線量値（`dose_eval`）です。
      * **単位:** こちらも座標軸は\*\*ミリメートル (mm)\*\*である必要があります。

  * `dose_ta` (Dose To Agreement)

      * **内容:** 線量差の許容値で、いわゆる\*\*DD (Dose Difference)\*\*基準です。
      * **単位:** \*\*パーセント (%)\*\*で指定します。このパーセンテージは、実測データの最大線量に対する割合で評価されます。

  * `dist_ta` (Distance To Agreement)

      * **内容:** 位置ずれの許容値で、いわゆる\*\*DTA (Distance To Agreement)\*\*基準です。
      * **単位:** \*\*ミリメートル (mm)\*\*で指定します。

  * `lower_percent_dose_cutoff`

      * **内容:** ガンマ評価の対象から除外する低線量領域を指定します。例えば`10`を指定すると、最大線量の10%以下の領域は評価されません。これは、ノイズの影響が大きい低線量部が評価結果に過剰な影響を与えるのを防ぐために、一般的に行われる設定です。
      * **単位:** \*\*パーセント (%)\*\*で指定します。

-----

## 💿 セットアップ

### 1\. 必要なもの

  * Python (バージョン3.8以上を推奨)

### 2\. フォルダ構成

このツールは、以下のフォルダ構成を前提としています。

```
phits-linac-validation/
│
├── 📜 README.md
├── 📄 config.ini          <-- ★設定ファイル
│
├── 🐍 src/
│   └── Comp_measured_phits_v9.1.py
│
├── 📊 data/
│   ├── phits_output/
│   └── measured_csv/
│
└── 📈 output/
```

### 3\. 設定ファイル (`config.ini`)

プロジェクトのルートディレクトリに`config.ini`を作成し、各フォルダのパスを指定します。これにより、スクリプトはどこにデータがあり、どこに結果を保存すればよいかを把握します。

**`config.ini` の内容例:**

```ini
[Paths]
phits_data_dir = data/phits_output/
measured_data_dir = data/measured_csv/
output_dir = output/
```

### 4\. ライブラリのインストール

ターミナルでプロジェクトのルートフォルダに移動し、以下のコマンドを実行して必要なライブラリをインストールします。

```bash
pip install pandas numpy matplotlib scipy pymedphys
```

-----

## 使い方

スクリプトは**必ずプロジェクトのルートディレクトリから実行してください。**

### モード1：対話メニューモード 👩‍💻

引数を何も指定せずにスクリプトを実行すると、対話モードが起動します。`config.ini`で指定されたフォルダ内からファイルを選択できます。

```bash
# プロジェクトルートから実行
python src/Comp_measured_phits_v9.1.py
```

### モード2：コマンドライン引数モード 🚀

ターミナルから**ファイル名のみ**を指定して実行します。スクリプトは`config.ini`を元にファイルのフルパスを自動で解決します。

#### コマンドの基本構造

```bash
python src/Comp_measured_phits_v9.1.py [PHITSファイル名] [実測CSVファイル名] [オプション]
```

#### 引数の説明

  * **必須引数:**

      * `phits_file`: PHITSの出力**ファイル名** (`.out`, `.dat`)
      * `measured_file`: 実測データの**ファイル名** (`.csv`)

  * **オプション引数:**

      * `--scale`: スケーリング係数 (例: `--scale 1.05`)
      * `--window`: 平滑化のウィンドウ幅 (奇数) (例: `--window 7`)
      * `--order`: 平滑化の多項式次数 (例: `--order 3`)
      * `--dd`: ガンマ評価の線量差(%)許容値 (例: `--dd 2.0`)
      * `--dta`: ガンマ評価の距離(mm)許容値 (例: `--dta 2.0`)
      * `--cutoff`: ガンマ評価で無視する低線量域(%) (例: `--cutoff 15.0`)
      * `--no-plot`: グラフを画面に表示せずに終了するフラグ

#### 実行例

```bash
# プロジェクトルートから実行
python src/Comp_measured_phits_v9.1.py deposit-z-water.out 10x10mPDD-zZver.csv --scale 1.02 --dd 2.0 --dta 2.0
```

-----

## 📊 出力ファイル

スクリプトを実行すると、`config.ini`で指定した`output_dir`フォルダの中に、以下の2種類のファイルが保存されます。

1.  **グラフ画像 (`output/plots/Comp_... .png`)**
      * 青い点: 実測データ
      * 灰色の点線: PHITSの生データ（正規化のみ）
      * 赤い実線: PHITSデータ（スケーリング＆平滑化適用後）
2.  **レポート (`output/reports/Report_... .txt`)**
      * 使用したファイル名、解析パラメータ、計算されたRMSEとガンマパス率が記録されます。

-----

## ライセンス

このプロジェクトは[MITライセンス](https://www.google.com/search?q=LICENSE)の下で公開されています。